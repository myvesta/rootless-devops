#!/bin/bash

source /usr/local/bin/devops-func.sh
MODE="write"

number_of_arguments=$#

if [ $number_of_arguments -lt 2 ]; then
    echo "ERROR: Invalid number of arguments"
    echo "Usage:   sudo devops-chmod <permissions> <file_path>"
    echo "Example: sudo devops-chmod 755 /etc/test.txt"
    exit 1
fi

argument=""

if [ $number_of_arguments -eq 2 ]; then
    permissions="$1"
    file_path="$2"
fi
if [ $number_of_arguments -eq 3 ]; then
    argument="$1" # -R
    permissions="$2" # permissions
    file_path="$3" # file path
    shift
fi


if [ ! -z "$argument" ]; then
    allowed_parameters=0
    if [ "$argument" == "-R" ]; then
        allowed_parameters=1
    fi
    if [ $allowed_parameters -eq 0 ]; then
        echo "ERROR: First argument must be: -R"
        exit 1
    fi
fi


# Checking mask permissions for $permissions

# Allowed are:
# - octal values: 3 or 4 digits (eg 755, 0644)
# - symbolic: [ugoa]*[-+=][rwxXst]* (eg a=rw, u=rwx, g-w, o+x, etc.)

permission_regex_oct="^0?[0-7]{3,4}$"
permission_regex_sym="^([ugoa]*[-+=][rwxXst]*,?)+$"

if [[ ! "$permissions" =~ $permission_regex_oct ]] && [[ ! "$permissions" =~ $permission_regex_sym ]]; then
    echo "ERROR: Invalid permission mask: $permissions"
    echo "Valid examples: 755, 0644, a=rwx, u+rw, g-w, o+x"
    exit 1
fi


startup_checks "$MODE" "$file_path"
is_allowed_path_for_mode "$MODE" "$file_path"

if [ $number_of_arguments -eq 2 ]; then
    /usr/bin/chmod $permissions "$file_path"
elif [ $number_of_arguments -eq 3 ]; then
    /usr/bin/chmod $argument $permissions "$file_path"
fi
exit $?
