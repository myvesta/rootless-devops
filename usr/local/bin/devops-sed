#!/bin/bash

# Usage:   sudo devops-sed <1=single quote, 2=double quote> -i <search-replace regex> <file_path>
# Example1: sudo devops-sed 1 -i 's/old/new/' /etc/test.txt
# Example2: sudo devops-sed 2 -i "s/old/new/" /etc/test.txt

if [ $# -ne 4 ]; then
    echo "ERROR: Invalid number of arguments"
    echo "Usage:    sudo devops-sed <1=single quote, 2=double quote> -i <search-replace regex> <file_path>"
    echo "Example1: sudo devops-sed 1 -i 's/old/new/' /etc/test.txt"
    echo "Example2: sudo devops-sed 2 -i "s/old/new/" /etc/test.txt"
    exit 1
fi

source /usr/local/bin/devops-func.sh
MODE="write"

quote_type="$1" # 1=single quote, 2=double quote
argument1="$2" # -i
argument2="$3" # search-replace regex
file_path="$4" # file path

shift
shift
shift

if [ "$quote_type" != "1" ] && [ "$quote_type" != "2" ]; then
    echo "ERROR: First argument must be: 1 or 2 (1=single quote, 2=double quote)"
    exit 1
fi

allowed_parameters=0
if [ "$argument1" == "-i" ]; then
    allowed_parameters=1
fi

if [ $allowed_parameters -eq 0 ]; then
    echo "ERROR: Second argument must be: -i"
    exit 1
fi

startup_checks "$MODE" "$1"
is_allowed_path_for_mode "$MODE" "$1"

if [ "$quote_type" == "1" ]; then
    command="/usr/bin/sed -i '$argument2' \"$file_path\""
    eval $command
elif [ "$quote_type" == "2" ]; then
    /usr/bin/sed -i "$argument2" "$file_path"
fi
exit $?
