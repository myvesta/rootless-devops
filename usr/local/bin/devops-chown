#!/bin/bash

source /usr/local/bin/devops-func.sh
MODE="write"

number_of_arguments=$#

if [ $number_of_arguments -lt 2 ]; then
    echo "ERROR: Invalid number of arguments"
    echo "Usage:   sudo devops-chown [-R] <owner>[:<group>] <file_path>"
    echo "Example: sudo devops-chown root:root /etc/test.txt"
    echo "Example: sudo devops-chown -R root:root /etc/someFolder/"
    exit 1
fi

argument=""

if [ $number_of_arguments -eq 2 ]; then
    owner_group="$1"
    file_path="$2"
fi
if [ $number_of_arguments -eq 3 ]; then
    argument="$1" # -R
    owner_group="$2" # owner[:group]
    file_path="$3" # file path
    shift
fi


if [ ! -z "$argument" ]; then
    allowed_parameters=0
    if [ "$argument" == "-R" ]; then
        allowed_parameters=1
    fi
    if [ $allowed_parameters -eq 0 ]; then
        echo "ERROR: First argument must be: -R"
        exit 1
    fi
fi

# Validate $owner_group if it is set (when called with -R <owner>[:<group>] <file>)
if [[ ! "$owner_group" =~ ^[a-zA-Z0-9_-]+(:[a-zA-Z0-9_-]+)?$ ]]; then
    echo "ERROR: owner[:group] must contain only letters, numbers, underscores, and hyphens, optionally separated by a single colon."
    exit 1
fi


startup_checks "$MODE" "$file_path"
is_allowed_path_for_mode "$MODE" "$file_path"

if [ $number_of_arguments -eq 2 ]; then
    /usr/bin/chown $owner_group "$file_path"
elif [ $number_of_arguments -eq 3 ]; then
    /usr/bin/chown $argument $owner_group "$file_path"
fi
exit $?
